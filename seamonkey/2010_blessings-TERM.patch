https://github.com/erikrose/blessings/pull/137

Fixes: https://bugs.gentoo.org/654316

From 5fefc65c306cf9ec492e7b422d6bb4842385afbc Mon Sep 17 00:00:00 2001
From: Jay Kamat <jaygkamat@gmail.com>
Date: Fri, 24 Aug 2018 11:11:57 -0700
Subject: [PATCH 1/2] Fix error when TERM is unset or improperly set

---
 python/mach/mach/logging.py                        |    2 +-
 third_party/python/blessings/blessings/__init__.py |    9 +++++++--
 2 files changed, 8 insertions(+), 3 deletions(-)

--- a/python/mach/mach/logging.py
+++ b/python/mach/mach/logging.py
@@ -88,17 +88,17 @@
         return t
 
 
 class StructuredTerminalFormatter(StructuredHumanFormatter):
     """Log formatter for structured messages writing to a terminal."""
 
     def set_terminal(self, terminal):
         self.terminal = terminal
-        self._sgr0 = blessings.tigetstr('sgr0') or '' if terminal and blessings else ''
+        self._sgr0 = terminal.normal if terminal and blessings else ''
 
     def format(self, record):
         f = record.msg.format(**record.params)
 
         if not self.write_times:
             return f
 
         t = self.terminal.blue(format_seconds(self._time(record)))
--- a/third_party/python/blessings/blessings/__init__.py
+++ b/third_party/python/blessings/blessings/__init__.py
@@ -89,18 +89,23 @@
                                  if stream_descriptor is None
                                  else stream_descriptor)
         if self._does_styling:
             # Make things like tigetstr() work. Explicit args make setupterm()
             # work even when -s is passed to nosetests. Lean toward sending
             # init sequences to the stream if it has a file descriptor, and
             # send them to stdout as a fallback, since they have to go
             # somewhere.
-            setupterm(kind or environ.get('TERM', 'unknown'),
-                      self._init_descriptor)
+            try:
+        	setupterm(kind or environ.get('TERM', 'dumb') or 'dumb',
+        	          self._init_descriptor)
+            except curses.error:
+        	# There was an error setting up the terminal, either curses is
+        	# not supported or TERM is incorrectly set. Fall back to dumb.
+        	self._does_styling = False
 
         self.stream = stream
 
     # Sugary names for commonly-used capabilities, intended to help avoid trips
     # to the terminfo man page and comments in your code:
     _sugar = dict(
         # Don't use "on" or "bright" as an underscore-separated chunk in any of
         # these (e.g. on_cology or rock_on) so we don't interfere with
